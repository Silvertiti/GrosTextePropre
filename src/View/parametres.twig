{% extends "layout.html.twig" %}

{% block style %}
  :root {
    --sidebar-bg: #1e1e1e;
    --active-color: #ff6b6b;
    --text-light: #f8f9fa;
  }

  .settings-container {
    display: flex;
    flex-direction: column;
    min-height: calc(100vh - 56px);
  }

  @media (min-width: 992px) {
    .settings-container {
      flex-direction: row;
    }
  }

  .settings-sidebar {
    background: var(--sidebar-bg);
    padding: 1rem 0;
    overflow-y: auto;
  }

  @media (max-width: 1000px) {
    .settings-sidebar {
      display: flex;
      overflow-x: auto;
      white-space: nowrap;
      padding: 3rem;
      border-bottom: 1px solid rgba(0,0,0,0.1);
    }
  }

  .settings-nav {
    display: flex;
    flex-direction: column;
    gap: 0.25rem;
  }

  @media (max-width: 1000px) {
    .settings-nav {
      flex-direction: row;
    }
  }

  .settings-nav-link {
    color: #adb5bd;
    padding: 0.75rem 1.25rem;
    text-decoration: none;
    display: flex;
    align-items: center;
    gap: 0.75rem;
    transition: all 0.2s;
  }

  @media (max-width: 1000px) {
    .settings-nav-link {
      padding: 0.75rem;
      border-radius: 4px;
    }
  }

  .settings-nav-link:hover,
  .settings-nav-link.active {
    color: var(--text-light);
    background: rgba(255,255,255,0.05);
  }

  .settings-nav-link.active {
    border-left: 3px solid var(--active-color);
  }

  @media (max-width: 991.98px) {
    .settings-nav-link.active {
      border-left: none;
      border-bottom: 3px solid var(--active-color);
    }
  }

  .settings-nav-link i {
    font-size: 1.3rem;
  }

  .settings-content {
    flex: 1;
    padding: 1.5rem;
    background: #f8f9fa;
  }

  @media (max-width: 767.98px) {
    .settings-content {
      padding: 1rem;
    }
  }

  .settings-section {
    display: none;
  }

  .settings-section.active {
    display: block;
    animation: fadeIn 0.3s ease;
  }

  @keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
  }

  .section-title {
    font-size: 1.5rem;
    margin-bottom: 1.5rem;
    color: #212529;
    font-weight: 600;
  }

  .table-responsive {
    width: 100%;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
    margin-bottom: 1rem;
    border-radius: 0.25rem;
    box-shadow: 0 0 0 1px rgba(0,0,0,0.1);
  }

  .table {
    width: 100%;
    margin-bottom: 0;
  }

  .table th {
    white-space: nowrap;
    background: #f1f3f5;
  }

  .search-box {
    margin-bottom: 1.5rem;
  }

  .btn-group-sm .btn {
    padding: 0.25rem 0.5rem;
    font-size: 0.8rem;
  }

  .badge {
    font-weight: 500;
    padding: 0.35em 0.65em;
  }
{% endblock %}

{% block content %}
<div class="settings-container">
  <div class="settings-sidebar col-lg-2">
    <nav class="settings-nav">
      <a href="#profile" class="settings-nav-link active">
        <i class="bi bi-person"></i>
        <span>Mon compte</span>
      </a>

      {% if session.role == 'admin' %}
        <a href="#entreprise" class="settings-nav-link">
          <i class="bi bi-building"></i>
          <span>Entreprises</span>
        </a>
        <a href="#stage" class="settings-nav-link">
          <i class="bi bi-briefcase"></i>
          <span>Offres de stage</span>
        </a>
        <a href="#promotion" class="settings-nav-link">
          <i class="bi bi-people"></i>
          <span>Pilotes</span>
        </a>
        <a href="#étudiants" class="settings-nav-link">
          <i class="bi bi-mortarboard"></i>
          <span>Étudiants</span>
        </a>
        <a href="#candidature" class="settings-nav-link">
          <i class="bi bi-file-text"></i>
          <span>Candidatures</span>
        </a>
      {% endif %}
    </nav>
  </div>

  <!-- Contenu principal -->
  <main class="settings-content">
    <!-- Section Profil -->
    <section id="profile" class="settings-section active">
      <h1 class="section-title">Mon profil</h1>
      <p>Gérez vos informations personnelles et vos paramètres de compte.</p>
    </section>

    {% if session.role == 'admin' %}
      <!-- Section Entreprises -->
      <section id="entreprise" class="settings-section">
        <h1 class="section-title">Gestion des entreprises</h1>
        <p>Gérez les entreprises partenaires.</p>
      </section>

      <!-- Section Offres de stage -->
      <section id="stage" class="settings-section">
        <h1 class="section-title">Offres de stage</h1>
        
        <div class="search-box">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" placeholder="Rechercher par titre ou entreprise..." id="stageSearch">
          </div>
        </div>

        {% if offres is not empty %}
          <div class="table-responsive">
            <table class="table table-hover" id="stagesTable">
              <thead>
                <tr>
                  <th>Titre</th>
                  <th>Entreprise</th>
                  <th>Statut</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for offre in offres %}
                  <tr>
                    <td>{{ offre.getTitre() }}</td>
                    <td>{{ offre.getEntreprise() }}</td>
                    <td>
                      {% if offre.isDisponible() %}
                        <span class="badge bg-success">Disponible</span>
                      {% else %}
                        <span class="badge bg-secondary">Terminé</span>
                      {% endif %}
                    </td>
                    <td>
                      <div class="btn-group btn-group-sm">
                        <a href="/stages/{{ offre.getId() }}/edit" class="btn btn-outline-primary">
                          <i class="bi bi-pencil"></i>
                        </a>
                        <form method="POST" action="/stages/{{ offre.getId() }}/delete" onsubmit="return confirm('Supprimer cette offre ?');">
                          <button type="submit" class="btn btn-outline-danger">
                            <i class="bi bi-trash"></i>
                          </button>
                        </form>
                      </div>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Aucune offre disponible actuellement.
          </div>
        {% endif %}
      </section>

      <!-- Section Pilotes -->
      <section id="promotion" class="settings-section">
        <h1 class="section-title">Pilotes de promotion</h1>
        
        <div class="search-box">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" placeholder="Rechercher un pilote..." id="piloteSearch">
          </div>
        </div>

        {% if tuteurs is not empty %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Nom</th>
                  <th>Prénom</th>
                  <th>Email</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for tuteur in tuteurs %}
                  <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ tuteur.getNom() }}</td>
                    <td>{{ tuteur.getPrenom() }}</td>
                    <td>{{ tuteur.getEmail() }}</td>
                    <td>
                      <a href="/pilote/{{ tuteur.getId() }}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-eye"></i> Voir
                      </a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Aucun pilote enregistré.
          </div>
        {% endif %}
      </section>

      <!-- Section Étudiants -->
      <section id="étudiants" class="settings-section">
        <h1 class="section-title">Étudiants</h1>
        
        <div class="search-box">
          <div class="input-group">
            <span class="input-group-text"><i class="bi bi-search"></i></span>
            <input type="text" class="form-control" placeholder="Rechercher un étudiant..." id="studentSearch">
          </div>
        </div>

        {% if students is not empty %}
          <div class="table-responsive">
            <table class="table table-hover">
              <thead>
                <tr>
                  <th>#</th>
                  <th>Nom</th>
                  <th>Prénom</th>
                  <th>Email</th>
                  <th>Actions</th>
                </tr>
              </thead>
              <tbody>
                {% for student in students %}
                  <tr>
                    <td>{{ loop.index }}</td>
                    <td>{{ student.getNom() }}</td>
                    <td>{{ student.getPrenom() }}</td>
                    <td>{{ student.getEmail() }}</td>
                    <td>
                      <a href="/etudiant/{{ student.getId() }}" class="btn btn-sm btn-outline-primary">
                        <i class="bi bi-eye"></i> Voir
                      </a>
                    </td>
                  </tr>
                {% endfor %}
              </tbody>
            </table>
          </div>
        {% else %}
          <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> Aucun étudiant enregistré.
          </div>
        {% endif %}
      </section>

      <!-- Section Candidatures -->
      <section id="candidature" class="settings-section">
        <h1 class="section-title">Candidatures</h1>
        <p>Gérez les candidatures aux offres de stage.</p>
      </section>
    {% endif %}
  </main>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
  // Gestion des onglets
  const navLinks = document.querySelectorAll('.settings-nav-link');
  const sections = document.querySelectorAll('.settings-section');
  
  navLinks.forEach(link => {
    link.addEventListener('click', function(e) {
      e.preventDefault();
      
      // Retirer la classe active de tous les liens et sections
      navLinks.forEach(l => l.classList.remove('active'));
      sections.forEach(s => s.classList.remove('active'));
      
      // Ajouter la classe active au lien cliqué
      this.classList.add('active');
      
      // Afficher la section correspondante
      const targetId = this.getAttribute('href');
      document.querySelector(targetId).classList.add('active');
      
      // Scroll vers le haut pour mobile
      if (window.innerWidth < 992) {
        window.scrollTo(0, 0);
      }
    });
  });
  
  // Fonction de recherche générique
  function setupSearch(inputId, tableSelector) {
    const searchInput = document.getElementById(inputId);
    if (searchInput) {
      searchInput.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase();
        const rows = document.querySelectorAll(`${tableSelector} tbody tr`);
        
        rows.forEach(row => {
          const rowText = row.textContent.toLowerCase();
          row.style.display = rowText.includes(searchTerm) ? '' : 'none';
        });
      });
    }
  }
  
  // Initialiser les recherches
  setupSearch('stageSearch', '#stagesTable');
  setupSearch('piloteSearch', '#promotion table');
  setupSearch('studentSearch', '#étudiants table');
  
  // Adaptation pour mobile
  function handleMobileView() {
    if (window.innerWidth < 992) {
      document.querySelector('.settings-sidebar').style.position = 'static';
    }
  }
  
  window.addEventListener('resize', handleMobileView);
  handleMobileView();
});
</script>
{% endblock %}